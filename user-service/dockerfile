# ============================================
# STAGE 1: Build Stage
# ============================================
FROM eclipse-temurin:21-jdk-alpine AS builder

# Çalışma dizini
WORKDIR /app

# Maven Wrapper ve pom.xml kopyala (cache için)
COPY mvnw .
COPY .mvn .mvn
COPY pom.xml .

# Maven Wrapper'a çalıştırma izni ver
RUN chmod +x ./mvnw

# Dependency'leri indir (cache layer)
RUN ./mvnw dependency:go-offline -B

# Kaynak kodları kopyala
COPY src src

# Uygulamayı build et (testleri atla - CI/CD'de çalışacak)
RUN ./mvnw clean package -DskipTests

# JAR dosyasını extract et (layered jar için)
RUN java -Djarmode=layertools -jar target/*.jar extract

# ============================================
# STAGE 2: Runtime Stage
# ============================================
FROM eclipse-temurin:21-jre-alpine AS runtime

# Güvenlik:  root olmayan kullanıcı oluştur
RUN addgroup -S spring && adduser -S spring -G spring

# Çalışma dizini
WORKDIR /app

# Ownership ayarla
RUN chown -R spring:spring /app
USER spring:spring

# Layered JAR'ı kopyala (cache optimization)
COPY --from=builder /app/dependencies/ ./
COPY --from=builder /app/spring-boot-loader/ ./
COPY --from=builder /app/snapshot-dependencies/ ./
COPY --from=builder /app/application/ ./

# Port
EXPOSE 8081

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
    CMD wget -qO- http://localhost:8081/actuator/health || exit 1

# Uygulama başlat
ENTRYPOINT ["java", "org.springframework.boot.loader.launch.JarLauncher"]